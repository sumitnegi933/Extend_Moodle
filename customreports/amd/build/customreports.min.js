define(["jquery","jqueryui","core/ajax","core/str","core/form-autocomplete","core/notification","core/templates","core/url"],function(a,b,c,d,e,f,g,h){var i={showCoursesItems:function(){var b=parseInt(a(this).val());if(i.clearActivitiesitems(),b){var d={methodname:"block_customreports_get_courses_list",args:{categoryid:b},done:function(b){var c=[],b=a.map(b,function(a){return[a]});c.courses=b,g.render("block_customreports/courselist",c).done(function(b){a("#id_course").html(b),a("#id_course").removeAttr("disabled")})}};c.call([d])}else i.clearCoursesitems()},showActivitiesItems:function(){var b=parseInt(a(this).val()),d=a("[name='reporttype']:checked").val();if(b){var e={methodname:"block_customreports_get_activities_list",args:{courseid:b,report:d},done:function(b){var c=[],b=a.map(b,function(a){return[a]});c.activities=b,g.render("block_customreports/activitylist",c).done(function(b){a("#id_activity").html(b),a("#id_activity").removeAttr("disabled")})}};c.call([e])}},clearActivitiesitems:function(){d.get_string("all").done(function(b){a(".customreportsform #id_activity").html("<option value=0>"+b+"</option>"),a(".customreportsform #id_activity").attr("disabled","disabled")})},clearCoursesitems:function(){d.get_string("all").done(function(b){a(".customreportsform #id_course").html("<option value=0>"+b+"</option>")}),a(".customreportsform #id_course").attr("disabled","disabled")},addProfileItem:function(){var b=a(this).val(),c=a(this).find("option:selected").text();a("#id_userprofile option[value="+b+"]").remove();var d=[];d.field=b,d.label=c,"country"==b?a.ajax({url:"country.php",dataType:"json",success:function(b){d.makeinput=0,d.countries=b,g.render("block_customreports/country",d).done(function(b){a("#profilefield_filters").append(b)})},deferRequestBy:400}):g.render("block_customreports/addprofilefield",d).done(function(c){a("#profilefield_filters").append(c),a("#"+b).autocomplete({source:function(c,d){a.ajax({url:"auto_suggestion.php",dataType:"json",data:{field:b,search:c.term},success:function(a){d(a)},deferRequestBy:400})}})})},removeProfileItem:function(){var b=a(this).attr("profilefield"),c=a(this).attr("profilelabel");a(this).closest("#"+b+"_container").remove(),a("#id_userprofile").append(a("<option></option>").attr("value",b).text(c))},setup:function(){a("body").delegate(".customreportsform #id_category","change",i.showCoursesItems),a("body").delegate(".customreportsform #id_course","change",i.showActivitiesItems),a("body").delegate(".customreportsform #id_userprofile","change",i.addProfileItem),a("body").delegate(".removefieldcontainer","click",i.removeProfileItem),a("body").delegate(".customreportsform","submit",i.getReport),a("body").delegate(".customreportsform #id_exportcsv","click",i.exportreport),a("body").delegate(".customreportsform #id_submitbutton","click",i.showReport),a("body").delegate(".pagination .page-item","click",i.paginationShowReport)},showReport:function(){i.exportReport=!1,a(".customreportsform").submit()},paginationShowReport:function(b){b.preventDefault();var c,d=a(this).find("a").attr("href"),e=d.slice(d.indexOf("?")+1).split("&");a(".customreportsform").find(".hiddenelement").html("");for(var f=0;f<e.length;f++){var c=e[f].split("="),g=a(".customreportsform").find(".hiddenelement");g.append('<input type="hidden" value='+c[1]+" name="+c[0]+">")}i.exportReport=!1,a(".customreportsform").submit()},exportreport:function(){if(a(".customreportsform").find(".hiddenelement").append('<input type="hidden" value="csv" name="format">'),i.validateFilters(),!i.generateReport)return!1;i.exportReport=!0;var b=a("[name='reporttype']:checked").val();a(".customreportsform").attr("action",h.fileUrl("/blocks/customreports/type/"+b+".php","")),a(".customreportsform").submit()},getReport:function(b){if(i.exportReport)return!0;a(".customreportsform").attr("action",h.fileUrl("/blocks/customreports/addreport.php","")),b.preventDefault(),a("input[name='format']").remove();var c=a("[name='reporttype']:checked").val();if(i.validateFilters(),!i.generateReport)return!1;var d={};if(0==a("#id_category").val())return!1;var e="";d=a(this).serializeArray(),e=a("#id_submitbutton"),a("#id_submitbutton").attr("disabled","disabled"),a(".reportContainer").html(""),a(".spinnercontainer").show(),a.ajax({url:h.fileUrl("/blocks/customreports/type/"+c+".php",""),data:d,context:e,complete:function(){a(".spinnercontainer").hide(),e.removeAttr("disabled"),a(".customreportsform").find(".hiddenelement").html("")},error:function(){a(".reportContainer").html("<div class='alert alert-danger'>error on page</div>")},statusCode:{404:function(){var b="<div class='alert alert-danger'>";b+="Coding error detected, please contact to site Admin",b+="</div>",a(".reportContainer").html(b)}},success:function(b){a(".reportContainer").html(b)}})},submitReport:function(a){a.preventDefault(),i.getReport()},validateFilters:function(){if(a("[name='datefilter']:checked").val()){var b=a("[name='datefrom[year]']").val(),c=a("[name='datefrom[month]']").val(),e=a("[name='datefrom[day]']").val(),f=a("[name='dateto[year]']").val(),g=a("[name='dateto[month]']").val(),h=a("[name='dateto[day]']").val(),j=new Date(b,c,e),k=new Date(f,g,h);if(j>k)return d.get_string("invalidaterange","block_customreports").done(function(a){i.showValidationErrorMessage(a)}),void(i.generateReport=!1)}if(0==a("#id_category").val()||""==a("#id_category").val())return d.get_string("invalidcategory","block_customreports").done(function(a){i.showValidationErrorMessage(a)}),void(i.generateReport=!1);if(!a("[name='reporttype']").val())return d.get_string("invalidreporttype","block_customreports").done(function(a){i.showValidationErrorMessage(a)}),void(i.generateReport=!1);var l=!0;return a("[name='usefilefilter']").is(":checked")&&!a(".filepicker-filename a").length&&d.get_string("filenotuploaded","block_customreports",a(this).attr("placeholder")).then(function(a){i.showValidationErrorMessage(a)}),a("[name='usefilefilter']").is(":not(:checked)")&&a("[name*='filter_profile']").each(function(){if(!a(this).val()){var b=a(this).attr("placeholder"),c=d.get_string("invalidprofilefield","block_customreports",b);c.then(function(a){i.showValidationErrorMessage(a)}),l=!1}}),l?0==a("#id_course").val()?(d.get_string("selectcourse","block_customreports").done(function(a){i.showValidationErrorMessage(a)}),void(i.generateReport=!1)):(i.generateReport=!0,a(".customreportvalidationerror").hide(),void a(".customreportvalidationerror").text("")):void(i.generateReport=!1)},showValidationErrorMessage:function(b){a(".customreportvalidationerror").show(),a(".customreportvalidationerror").text(b).focus(),a(window).scrollTop(0)},generateReport:!0,exportReport:!1};return{setup:i.setup}});